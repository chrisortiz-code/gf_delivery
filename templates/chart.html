{% extends "base.html" %}

{% block title %}Order & Payment History{% endblock %}

{% block header_title %}Order & Payment History{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="/static/styles.css">
{% endblock %}

{% block content %}
<div>
{% if selected_maestro %}
  <p>Maestros: {{ selected_maestro.split(';') | join(', ') }}</p>
{% endif %}
<div style="text-align:center">
  <form method="get" action="/chart" id="chart-filter-form">
    <div>
      <label><b>Select Location:</b></label>
      {% for site_id, location in sites %}
        <label>
          <input type="radio" name="site_id" value="{{ site_id }}" onchange="updateBosses()"> {{ location }}
        </label>
      {% endfor %}
    </div>
    <div id="bosses-section"></div>
    <input type="hidden" name="boss_id" id="hidden_boss_id">
    <div>
      <label for="employee_id"><b>Select Employee:</b></label>
      <select name="employee_id" id="employee_id" onchange="submitWithBoss()" disabled>
        <option value="">-- Select Employee --</option>
      </select>
    </div>
  </form>
</div>

{% if orders or payments %}
  <h4 style="margin-top:2em;">Orders & Payments</h4>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Employee</th>
        <th>Date</th>
        <th>Items / Note</th>
        <th>Total / Amount</th>
        <th>Signature</th>
      </tr>
    </thead>
    <tbody>
      {% for entry in all_entries %}
        <tr{% if entry.type == 'payment' %} style="background:#ffeaea;"{% elif entry.type == 'order' %} style="background:#eaf2ff;"{% endif %}>
          <td>{{ entry.type|capitalize }}</td>
          <td>{{ entry.employee_name }}</td>
          <td>{{ entry.date }}</td>
          <td>
            {% if entry.type == 'order' %}
              <ul style="list-style: none; padding-left: 0; margin: 0;">
                {% for item in entry.parsed_items %}
                  <li>{{ item.name }} @ ${{ item.price }} Ã— {{ item.qty }}</li>
                {% endfor %}
              </ul>
            {% else %}
              {{ entry.note or '' }}
            {% endif %}
          </td>
          <td>
            {% if entry.type == 'order' %}
              ${{ entry.total }}
            {% else %}
              -${{ entry.amount }}
            {% endif %}
          </td>
          <td>
            {% if entry.type == 'order' and entry.signature %}
              <img src="{{ entry.signature }}" alt="Signature" style="max-width: 80px; max-height: 40px; border: 1px solid #ccc;">
            {% elif entry.type == 'order' %}
              <em>No signature</em>
            {% else %}
              <em>-</em>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
      <tr style="font-weight:bold; border-top:2px solid #181818;">
        <td colspan="5" style="text-align:right;">Debit (Orders)</td>
        <td>${{ order_total }}</td>
      </tr>
      <tr style="font-weight:bold;">
        <td colspan="5" style="text-align:right;">Credit (Payments)</td>
        <td>-${{ payment_total }}</td>
      </tr>
      <tr style="font-weight:bold; background:#f0f0f0;">
        <td colspan="5" style="text-align:right;">Owed</td>
        <td>${{ net_total }}</td>
      </tr>
    </tbody>
  </table>
{% else %}
  <div style="text-align:center;"><p style="color:gray;">No orders or payments found for this selection.</p></div>
{% endif %}

{% if session.get('is_admin') and selected_employee %}
  <form method="post" style="margin-top:2em; border:1px solid #ccc; padding:1em; border-radius:8px; background:#f9f9f9; max-width:400px; margin-left:auto; margin-right:auto;">
    <h4>Receive Payment{% if selected_employee == 'all' %} (All Employees at this Site){% endif %}</h4>
    <input type="hidden" name="site_id" value="{{ selected_site }}">
    <input type="hidden" name="employee_id" value="{{ selected_employee }}">
    <input type="hidden" name="payment_key" value="{{ payment_key }}">
    <div style="margin-bottom:1em;">
      <label for="amount">Amount:</label>
      <input type="number" name="amount" id="amount" min="1" required style="width:100%; padding:6px;">
    </div>
    <div style="margin-bottom:1em;">
      <label for="note">Note (optional):</label>
      <input type="text" name="note" id="note" style="width:100%; padding:6px;">
    </div>
    <button type="submit" class="centered-btn" style="background:#5a866b; color:white; padding:8px 18px; border:none; border-radius:6px;">Add Payment</button>
  </form>
{% endif %}


</div>
{% endblock %}

{% block scripts %}
<script>
  const siteBosses = {{ site_bosses|tojson }};
  let selectedSite = null;
  let selectedBoss = null;
  function updateBosses() {
    const siteRadios = document.querySelectorAll('input[name="site_id"]');
    let siteId = null;
    siteRadios.forEach(r => { if (r.checked) siteId = r.value; });
    selectedSite = siteId;
    const bossesSection = document.getElementById('bosses-section');
    bossesSection.innerHTML = '';
    document.getElementById('employee_id').innerHTML = '<option value="all">All Employees</option>';
    document.getElementById('employee_id').disabled = true;
    document.getElementById('hidden_boss_id').value = '';
    if (!siteId) {
      bossesSection.style.display = 'none';
      return;
    }
    const bosses = siteBosses[siteId];
    if (!bosses || Object.keys(bosses).length === 0) {
      bossesSection.style.display = 'none';
      return;
    }
    bossesSection.style.display = 'block';
    let html = '<div><b>Select Boss:</b><br>';
    for (const bossId in bosses) {
      html += `<label><input type="radio" name="boss_id" value="${bossId}" onchange="updateEmployees()"> ${bosses[bossId].name}</label>`;
    }
    html += '</div>';
    bossesSection.innerHTML = html;
  }
  function updateEmployees() {
    const bossRadios = document.querySelectorAll('input[name="boss_id"]');
    let bossId = null;
    bossRadios.forEach(r => { if (r.checked) bossId = r.value; });
    selectedBoss = bossId;
    document.getElementById('hidden_boss_id').value = bossId || '';
    const empSelect = document.getElementById('employee_id');
    empSelect.innerHTML = '<option value="all">All Employees</option>';
    empSelect.disabled = true;
    if (!selectedSite || !bossId) return;
    const employees = siteBosses[selectedSite][bossId].employees;
    for (const emp of employees) {
      const opt = document.createElement('option');
      opt.value = emp.id;
      opt.textContent = emp.name;
      empSelect.appendChild(opt);
    }
    if (employees.length > 0) empSelect.disabled = false;
  }
  function submitWithBoss() {
    // Ensure boss_id is set before submitting
    const bossRadios = document.querySelectorAll('input[name="boss_id"]');
    let bossId = null;
    bossRadios.forEach(r => { if (r.checked) bossId = r.value; });
    document.getElementById('hidden_boss_id').value = bossId || '';
    document.getElementById('chart-filter-form').submit();
  }
  document.addEventListener('DOMContentLoaded', function() {
    // Read query params
    const params = new URLSearchParams(window.location.search);
    const siteId = params.get('site_id');
    const bossId = params.get('boss_id');
    const employeeId = params.get('employee_id');
    // Set site radio
    if (siteId) {
      const siteRadios = document.querySelectorAll('input[name="site_id"]');
      siteRadios.forEach(r => { if (r.value === siteId) r.checked = true; });
    }
    updateBosses();
    // Set boss radio after rendering
    setTimeout(function() {
      if (bossId) {
        const bossRadios = document.querySelectorAll('input[name="boss_id"]');
        bossRadios.forEach(r => { if (r.value === bossId) r.checked = true; });
        document.getElementById('hidden_boss_id').value = bossId;
      }
      updateEmployees();
      // Set employee dropdown
      if (employeeId) {
        const empSelect = document.getElementById('employee_id');
        empSelect.value = employeeId;
      }
      // Always enable dropdown if boss and site are set and there are employees
      const empSelect = document.getElementById('employee_id');
      if (selectedSite && selectedBoss && empSelect.options.length > 0) {
        empSelect.disabled = false;
      }
    }, 0);
  });
</script>
{% endblock %}
